<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>å…±åŒåˆ¶ä½œãƒ„ãƒ¼ãƒ«</title>
    <style>
        /* --- å…¨ä½“åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« --- */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        h1 {
            color: #4CAF50;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* --- èµ·å‹•åˆ¶å¾¡ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #setup-screen {
            padding: 30px;
            border: 2px solid #ccc;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            background-color: #e8f5e9;
        }
        #setup-screen input[type="text"] {
            padding: 10px;
            width: 80%;
            max-width: 300px;
            margin: 10px 0 20px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #join-button {
            padding: 12px 25px;
            font-size: 18px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #join-button:hover {
            background-color: #45a049;
        }

        /* --- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± --- */
        .user-info {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px dashed #ccc;
            border-radius: 4px;
            display: inline-block;
        }
        
        /* --- æç”»ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« --- */
        .drawing-controls {
            display: none; 
            gap: 20px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        .tool-button.active {
            border: 2px solid #4CAF50;
            background-color: #e8f5e9;
        }

        /* --- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ --- */
        .room-content {
            border: 2px solid #ccc;
            border-radius: 4px;
            padding: 0; 
            min-height: 600px;
            margin-bottom: 20px;
            background-color: #fff;
            position: relative; 
            overflow: hidden;
        }
        #drawingCanvas {
            cursor: crosshair;
            display: block;
        }
        
        /* --- ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ«ã®èª¿æ•´ --- */
        textarea {
            width: 100%;
            height: 550px;
            border: none;
            padding: 15px; 
            box-sizing: border-box;
            resize: none;
            font-size: 16px;
            background-color: white;
            position: relative;
            z-index: 2; 
            line-height: 1.5; 
            font-family: monospace; 
        }
        #lyricsTextarea {
            height: 300px; 
        }

        /* ======================================= */
        /* â˜…â˜…â˜… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ã‚½ãƒ«åæ˜ ç”¨ã®CSS (æœ€çµ‚èª¿æ•´ç‰ˆ) â˜…â˜…â˜… */
        /* ======================================= */
        
        /* æç”»ãƒ«ãƒ¼ãƒ ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å…¨ä½“ã‚’ãƒã‚¦ã‚¹ç§»å‹•ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã®åŸºç‚¹ã«ã™ã‚‹ */
        #drawing-room-content {
            position: relative; /* å­è¦ç´ ã®absoluteåŸºæº– */
            overflow: hidden;
        }
        /* å°èª¬/éŸ³æ¥½ãƒ«ãƒ¼ãƒ ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å…¨ä½“ã‚’ãƒã‚¦ã‚¹ç§»å‹•ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã®åŸºç‚¹ã«ã™ã‚‹ */
        #novel-room, .music-section.room-content {
            position: relative; /* å­è¦ç´ ã®absoluteåŸºæº– */
            overflow: hidden;
        }
        
        /* ã‚«ãƒ¼ã‚½ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã¯ã€ãã®è¦ªè¦ç´ ã®(0,0)ã‚’åŸºæº–ã¨ã™ã‚‹ */
        .mouse-cursor-container, .text-cursor-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* ã‚«ãƒ¼ã‚½ãƒ«ã®ä¸‹ã®è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ */
            z-index: 100;
        }
        
        /* ãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ¼ã‚½ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã¯ textarea ã® content-box ã‹ã‚‰å§‹ã¾ã‚‹ã‚ˆã†ã«èª¿æ•´ */
        .text-cursor-container {
            top: 15px; /* textarea padding-top */
            left: 15px; /* textarea padding-left */
            width: calc(100% - 30px);
            height: calc(100% - 30px);
            z-index: 3; 
            overflow: hidden; 
        }
        
        /* å€‹ã€…ã®ãƒªãƒ¢ãƒ¼ãƒˆã‚«ãƒ¼ã‚½ãƒ«è¦ç´  */
        .remote-cursor {
            position: absolute;
            white-space: nowrap;
            z-index: 101;
            pointer-events: none;
            transition: transform 0.05s ease-out, left 0.05s ease-out, top 0.05s ease-out; /* ãªã‚ã‚‰ã‹ã«å‹•ãã‚ˆã†ã«ã™ã‚‹ */
            display: none;
        }
        
        /* ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ« (ä¸‰è§’å½¢ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã¾ãŸã¯æç”»ãƒ–ãƒ©ã‚·) */
        .remote-cursor.mouse-cursor {
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 6px 0 6px 8px; /* ä¸‰è§’å½¢ */
            border-color: transparent transparent transparent currentColor;
            transform: translate(0, 0); 
            top: 0;
            left: 0;
            background-color: transparent;
            border-radius: 0;
            box-shadow: none;
        }
        
        /* æç”»ãƒ«ãƒ¼ãƒ ã®ãƒ–ãƒ©ã‚·è¡¨ç¤ºç”¨ */
        .remote-cursor.mouse-cursor.draw-tool {
            border: 2px solid currentColor !important;
            border-radius: 50%;
            background-color: transparent !important;
            border-width: 0;
            width: 10px;
            height: 10px;
            margin: -5px 0 0 -5px;
            transform: none;
        }

        /* ãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ¼ã‚½ãƒ« (ç¸¦æ£’) */
        .remote-cursor.text-cursor {
            height: 1.5em; /* line-heightã¨åˆã‚ã›ã‚‹ */
            width: 2px;
            background-color: currentColor;
            border-radius: 1px;
            top: 0;
            left: 0;
            animation: none; /* ç‚¹æ»…ã‚’ã‚ªãƒ• */
        }
        
        /* ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚¿ã‚° */
        .remote-cursor-label {
            position: absolute;
            padding: 2px 5px;
            font-size: 10px;
            background-color: currentColor; 
            color: white;
            border-radius: 3px;
            white-space: nowrap;
            /* ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ã®å ´åˆ: ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã®æ ¹å…ƒä»˜è¿‘ã«è¡¨ç¤º */
            transform: translateY(-100%) translateX(2px);
            margin: 0;
            top: 0; 
            left: 0; 
        }
        /* ãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ¼ã‚½ãƒ«ä¸Šã®ã‚¿ã‚°ä½ç½® */
        .remote-cursor.text-cursor .remote-cursor-label {
            transform: translateY(-100%) translateX(0);
        }
        /* ======================================= */
        
        /* --- éŸ³æ¥½ãƒ«ãƒ¼ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯çœç•¥ --- */
        .music-section {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            position: relative; 
        }
        #music-urls-list {
            list-style: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
        }
        #music-urls-list li {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: grab;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff;
        }
        #music-urls-list li:last-child {
            border-bottom: none;
        }
        .remove-url {
            background: #ff5555;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        /* --- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã¯çœç•¥ --- */
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            align-items: center;
        }
        button {
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        #save-button {
            background-color: #2196F3;
            color: white;
        }
        #publish-button {
            background-color: #FF9800;
            color: white;
        }
        #work-title {
            padding: 10px;
            flex-grow: 1;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .status-message {
            margin-left: 15px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ–Šï¸ å…±åŒåˆ¶ä½œãƒ„ãƒ¼ãƒ«</h1>

        <div id="setup-screen">
            <h2>ã‚ˆã†ã“ãï¼ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨ãƒ«ãƒ¼ãƒ ã‚’é¸ã‚“ã§ãã ã•ã„</h2>
            <label for="initialNickname">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ :</label>
            <input type="text" id="initialNickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›" value="åç„¡ã—ã•ã‚“">
            
            <div id="initial-room-selection" class="room-selection" style="display: inline-block;">
                <input type="radio" id="initial-free-room" name="initial-room" value="free" checked>
                <label for="initial-free-room">ãƒ•ãƒªãƒ¼ãƒ«ãƒ¼ãƒ  (æç”»)</label>
                <input type="radio" id="initial-novel-room" name="initial-room" value="novel">
                <label for="initial-novel-room">å°èª¬ãƒ«ãƒ¼ãƒ </label>
                <input type="radio" id="initial-music-room" name="initial-room" value="music">
                <label for="initial-music-room">éŸ³æ¥½ãƒ«ãƒ¼ãƒ </label>
            </div>
            <br>
            <button id="join-button">ãƒ«ãƒ¼ãƒ ã«å‚åŠ ã™ã‚‹</button>
        </div>

        <div id="main-content" style="display: none;">
            
            <div class="user-info">
                <label>ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ :</label>
                <span id="currentRoomDisplay"></span>
                <label style="margin-left: 20px;">ç¾åœ¨ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ :</label>
                <span id="currentNicknameDisplay"></span>
            </div>

            <div id="drawing-room" class="room-content"> 
                <div class="drawing-controls" id="drawing-controls">
                    <label>ãƒ„ãƒ¼ãƒ«:</label>
                    <button id="penTool" class="tool-button active">ğŸ–Šï¸ ãƒšãƒ³</button>
                    <button id="eraserTool" class="tool-button">ğŸ§¹ æ¶ˆã—ã‚´ãƒ </button>
                    
                    <label for="penColor">è‰²:</label>
                    <input type="color" id="penColor" value="#000000">
                    <label for="penWidth">å¤ªã•:</label>
                    <input type="range" id="penWidth" min="1" max="50" value="5">
                    <span id="widthValue">5</span>px
                    <button id="clearCanvas">ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢</button>
                </div>
                <div class="room-content" id="drawing-room-content">
                    <div id="drawing-mouse-cursor-container" class="mouse-cursor-container"></div>
                    <canvas id="drawingCanvas" width="1000" height="600"></canvas>
                </div>
            </div>
            
            <div id="novel-room" class="room-content">
                <div id="novel-mouse-cursor-container" class="mouse-cursor-container"></div>
                <div id="novel-text-cursor-container" class="text-cursor-container"></div>
                <textarea id="novelTextarea" placeholder="å°èª¬ã‚’æ›¸ãã¾ã—ã‚‡ã†..."></textarea>
            </div>
            
            <div id="music-room">
                
                <div class="music-section room-content">
                    <h3>ğŸ“ æ­Œè©ãƒ»ã‚¢ã‚¤ãƒ‡ã‚¢</h3>
                    <div id="lyrics-mouse-cursor-container" class="mouse-cursor-container"></div>
                    <div id="lyrics-text-cursor-container" class="text-cursor-container"></div>
                    <textarea id="lyricsTextarea" placeholder="æ­Œè©ã€ã‚³ãƒ¼ãƒ‰é€²è¡Œã€åˆ¶ä½œã‚¢ã‚¤ãƒ‡ã‚¢ãªã©ã‚’æ›¸ãã¾ã—ã‚‡ã†..."></textarea>
                </div>

                <div class="music-section">
                    <h3>ğŸ¶ éŸ³æºURLãƒªã‚¹ãƒˆ (ä¸¦ã¹æ›¿ãˆå¯èƒ½)</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="newMusicUrl" placeholder="æ–°ã—ã„éŸ³æºã®URLã¾ãŸã¯åŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰ã‚’è²¼ä»˜" style="flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <button id="addMusicUrl" style="background-color: #3498db; color: white;">è¿½åŠ </button>
                    </div>
                    <ul id="music-urls-list">
                        </ul>
                </div>
            </div>

            <div class="controls">
                <input type="text" id="work-title" placeholder="ä½œå“ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›" required>
                <button id="save-button">ğŸ’¾ ä¸€æ™‚ä¿å­˜</button>
                <button id="publish-button">ğŸ“¢ ä½œå“ã‚’å…¬é–‹</button>
                <span id="publish-status" class="status-message"></span>
            </div>

            <div class="view-works">
                <a href="/published.html">å…¬é–‹ä½œå“ä¸€è¦§ã‚’è¦‹ã‚‹ â†’</a>
            </div>
        </div>
    </div>

    <script>
        // ã€é‡è¦ã€‘DOMæ“ä½œã«å¿…è¦ãªè¦ç´ ã®å–å¾—
        const setupScreen = document.getElementById('setup-screen');
        const mainContent = document.getElementById('main-content');
        const joinButton = document.getElementById('join-button');
        const initialNicknameInput = document.getElementById('initialNickname');
        const currentNicknameDisplay = document.getElementById('currentNicknameDisplay');
        const currentRoomDisplay = document.getElementById('currentRoomDisplay');

        const drawingRoom = document.getElementById('drawing-room');
        const novelRoom = document.getElementById('novel-room');
        const musicRoom = document.getElementById('music-room');
        const novelTextarea = document.getElementById('novelTextarea');
        const lyricsTextarea = document.getElementById('lyricsTextarea');
        
        const drawingRoomContent = document.getElementById('drawing-room-content');
        const novelRoomContent = document.getElementById('novel-room');
        const musicRoomContent = document.getElementById('music-room').querySelector('.music-section:first-child'); 
        
        const drawingMouseCursorContainer = document.getElementById('drawing-mouse-cursor-container');
        const novelMouseCursorContainer = document.getElementById('novel-mouse-cursor-container');
        const lyricsMouseCursorContainer = document.getElementById('lyrics-mouse-cursor-container');
        
        const novelTextCursorContainer = document.getElementById('novel-text-cursor-container');
        const lyricsTextCursorContainer = document.getElementById('lyrics-text-cursor-container');
        
        // æç”»ãƒ„ãƒ¼ãƒ«é–¢é€£
        const penToolButton = document.getElementById('penTool');
        const eraserToolButton = document.getElementById('eraserTool');
        const penColorInput = document.getElementById('penColor');
        const penWidthInput = document.getElementById('penWidth');
        const widthValueSpan = document.getElementById('widthValue');
        const clearCanvasButton = document.getElementById('clearCanvas');
        
        // éŸ³æ¥½ãƒ«ãƒ¼ãƒ é–¢é€£
        const newMusicUrlInput = document.getElementById('newMusicUrl');
        const addMusicUrlButton = document.getElementById('addMusicUrl');
        const musicUrlsList = document.getElementById('music-urls-list');

        // ä¿å­˜ãƒ»å…¬é–‹é–¢é€£
        const saveButton = document.getElementById('save-button');
        const publishButton = document.getElementById('publish-button');
        const workTitleInput = document.getElementById('work-title');
        const publishStatus = document.getElementById('publish-status');
        
        // WebSocketé–¢é€£ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let ws = null;
        let currentRoom = ''; 
        let nickname = '';
        let musicUrls = []; 
        let currentPenColor = '#000000';
        let currentPenWidth = 5;
        let currentTool = 'pen'; 

        // â˜…â˜…â˜… ã‚«ãƒ¼ã‚½ãƒ«é–¢é€£ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° â˜…â˜…â˜…
        const cursorColors = {}; 
        const colorPool = ['#E55039', '#4a69bd', '#4CAF50', '#ff9f43', '#1abc9c', '#9b59b6']; // ä½¿ç”¨ã™ã‚‹è‰²ã®ãƒ—ãƒ¼ãƒ«
        let colorIndex = 0;
        const remoteCursors = new Map(); // Key: nickname, Value: { mouseCursor: HTMLElement, textCursor: HTMLElement }

        // =========================================================
        // â˜…â˜…â˜… 1. èµ·å‹•åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
        // =========================================================

        joinButton.addEventListener('click', () => {
            const initialNickname = initialNicknameInput.value.trim() || 'åç„¡ã—ã•ã‚“';
            const initialRoomElement = document.querySelector('input[name="initial-room"]:checked');
            const initialRoom = initialRoomElement ? initialRoomElement.value : 'free';
            
            if (initialNickname) {
                nickname = initialNickname;
                currentRoom = initialRoom;
                currentNicknameDisplay.textContent = nickname;
                currentRoomDisplay.textContent = getRoomName(currentRoom);
                
                setupScreen.style.display = 'none';
                mainContent.style.display = 'block';

                initializeWebSocket(initialRoom);
            }
        });

        function getRoomName(room) {
            if (room === 'free') return 'ãƒ•ãƒªãƒ¼ãƒ«ãƒ¼ãƒ  (æç”»)';
            if (room === 'novel') return 'å°èª¬ãƒ«ãƒ¼ãƒ ';
            if (room === 'music') return 'éŸ³æ¥½ãƒ«ãƒ¼ãƒ ';
            return room;
        }

        function initializeWebSocket(initialRoom) {
            // ã€é‡è¦ã€‘ã‚µãƒ¼ãƒãƒ¼ã®å…¬é–‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã«æ›¸ãæ›ãˆã¦ãã ã•ã„
            ws = new WebSocket('wss://co-production.onrender.com'); 
            
            ws.onopen = () => {
                console.log('WebSocket connection established.');
                sendJoinRoom(initialRoom);
                loadInitialContent(initialRoom); 
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'content_update') {
                        if (data.room === 'free') {
                            handleReceivedDrawing(data);
                        } else if (data.room === 'novel' && data.room === currentRoom) {
                            novelTextarea.value = data.content;
                        } else if (data.room === 'music' && data.room === currentRoom) {
                             const [lyrics, urls] = parseMusicData(data.content); // ã‚µãƒ¼ãƒãƒ¼ã¯ãƒ†ã‚­ã‚¹ãƒˆå…¨ä½“ã‚’contentã§é€ã‚‹
                             lyricsTextarea.value = lyrics;
                             musicUrls = urls;
                             renderMusicUrls();
                        }
                    } else if (data.type === 'cursor_update' && data.room === currentRoom) { 
                        if (data.nickname === nickname) return;
                        updateRemoteCursor(data);
                    } else if (data.type === 'joined') {
                        // å‚åŠ è€…ãƒªã‚¹ãƒˆã®æ›´æ–°ãªã©ï¼ˆä»Šå›ã¯çœç•¥ï¼‰
                        console.log(`User joined: ${data.nickname}`);
                    }
                } catch (e) {
                    console.error('WebSocket message handling error:', e);
                }
            };

            ws.onclose = () => {
                console.log('WebSocket connection closed.');
            };

            // â˜…â˜…â˜… è¿½åŠ : ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒã‚¦ã‚¹/ãƒ†ã‚­ã‚¹ãƒˆãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã®è¨­å®š â˜…â˜…â˜…
            setupGlobalMouseTracking(); 
        }

        async function loadInitialContent(room) {
            // â˜…ã™ã¹ã¦ã®ãƒ«ãƒ¼ãƒ ã‚’ä¸€æ—¦éè¡¨ç¤ºã«ã—ã€é¸æŠã•ã‚ŒãŸãƒ«ãƒ¼ãƒ ã®ã¿è¡¨ç¤ºâ˜…
            drawingRoom.style.display = 'none';
            novelRoom.style.display = 'none';
            musicRoom.style.display = 'none';

            // ãƒªãƒ¢ãƒ¼ãƒˆã‚«ãƒ¼ã‚½ãƒ«ã‚’ã™ã¹ã¦éè¡¨ç¤ºã«ã™ã‚‹
            remoteCursors.forEach(({ mouseCursor, textCursor }) => {
                mouseCursor.style.display = 'none';
                textCursor.style.display = 'none';
            });

            // ã‚µãƒ¼ãƒãƒ¼APIã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ­ãƒ¼ãƒ‰
            const content = await fetchContentFromAPI(room);

            if (room === 'free') {
                drawingRoom.style.display = 'block';
                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãŸå±¥æ­´ã‚’æç”»
                if (content && content.history) {
                    redrawCanvas(content.history);
                }
                document.getElementById('drawing-controls').style.display = 'flex';
            } else if (room === 'novel') {
                novelRoom.style.display = 'block';
                novelTextarea.value = content || '';
            } else if (room === 'music') {
                musicRoom.style.display = 'block';
                const [lyrics, urls] = parseMusicData(content || '');
                lyricsTextarea.value = lyrics;
                musicUrls = urls;
                renderMusicUrls();
            }
        }
        
        async function fetchContentFromAPI(room) {
             try {
                const res = await fetch(`/api/content/${room}`);
                if (!res.ok) { 
                    console.error('Failed to load content:', res.statusText);
                    return room === 'free' ? { history: [] } : '';
                }
                const data = await res.json();
                return data.content;
            } catch (error) { 
                console.error(`ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ (${room}):`, error); 
                return room === 'free' ? { history: [] } : '';
            }
        }

        function parseMusicData(data) {
            const urlRegex = /\[URL: (.*?)\]/g;
            let lyrics = data;
            const urls = [];
            let match;
            
            // URLéƒ¨åˆ†ã‚’æŠ½å‡º
            while ((match = urlRegex.exec(data)) !== null) {
                urls.push(match[1]);
                lyrics = lyrics.replace(match[0], '').trim();
            }
            // æ­Œè©/ã‚¢ã‚¤ãƒ‡ã‚¢ã®ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ã‚’å‰Šé™¤
            lyrics = lyrics.replace(/\[æ­Œè©\/ã‚¢ã‚¤ãƒ‡ã‚¢\]:\n?/, '').trim();
            
            return [lyrics, urls];
        }


        // =========================================================
        // â˜…â˜…â˜… 2. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ã¨ã‚«ãƒ¼ã‚½ãƒ«ãƒ­ã‚¸ãƒƒã‚¯ (ã‚³ã‚¢æ©Ÿèƒ½) â˜…â˜…â˜…
        // =========================================================

        function sendJoinRoom(roomName) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'join',
                    room: roomName,
                    nickname: nickname
                }));
            }
        }
        
        // â˜…â˜…â˜… ã‚«ãƒ¼ã‚½ãƒ«è¡¨ç¤ºã«å¿…è¦ãªãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° â˜…â˜…â˜…
        
        function getColorForNickname(nickname) {
            if (!cursorColors[nickname]) {
                cursorColors[nickname] = colorPool[colorIndex % colorPool.length];
                colorIndex++;
            }
            return cursorColors[nickname];
        }

        function createCursorElement(id, container, nickname, color, cursorType) {
            const element = document.createElement('span');
            element.id = id;
            element.className = `remote-cursor ${cursorType}`;
            element.style.color = color;
            element.style.display = 'none';
            
            const label = document.createElement('span');
            label.className = 'remote-cursor-label';
            label.textContent = nickname;
            label.style.backgroundColor = color;
            
            element.appendChild(label);
            container.appendChild(element);
            return element;
        }

        /**
         * [NEW] éš ã—ãƒŸãƒ©ãƒ¼è¦ç´ ã‚’ä½¿ã£ã¦ã€textareaå†…ã®ã‚«ãƒ¼ã‚½ãƒ«ã®X, Yåº§æ¨™ã‚’è¨ˆç®—ã™ã‚‹
         * (textareaã®content-boxã®å·¦ä¸Šã‚’(0,0)ã¨ã—ãŸç›¸å¯¾åº§æ¨™ã‚’è¿”ã™)
         */
        function getTextareaCaretPosition(textarea, position) {
            // ... (æä¾›ã•ã‚ŒãŸå®‰å®šã—ãŸãƒ­ã‚¸ãƒƒã‚¯ã‚’ãã®ã¾ã¾ä½¿ç”¨) ...
            const mirror = document.createElement('div');
            const style = window.getComputedStyle(textarea);
            const textareaRect = textarea.getBoundingClientRect();

            const styleProperties = ['fontFamily', 'fontSize', 'lineHeight', 'paddingTop', 'paddingRight', 'paddingBottom', 'paddingLeft', 'borderTopWidth', 'borderRightWidth', 'borderBottomWidth', 'borderLeftWidth', 'boxSizing'];
            styleProperties.forEach(prop => {
                mirror.style[prop] = style[prop];
            });

            mirror.style.whiteSpace = 'pre-wrap';
            mirror.style.wordWrap = 'break-word';
            mirror.style.position = 'absolute';
            mirror.style.visibility = 'hidden';
            mirror.style.overflow = 'auto'; 
            mirror.style.width = textareaRect.width + 'px';

            const content = textarea.value;
            const preText = content.substring(0, position);
            const postText = content.substring(position); 

            const pre = document.createElement('span');
            pre.textContent = preText;
            
            const caretSpan = document.createElement('span');
            caretSpan.textContent = '\u200B'; 

            const post = document.createElement('span');
            post.textContent = postText;

            mirror.appendChild(pre);
            mirror.appendChild(caretSpan);
            mirror.appendChild(post);

            document.body.appendChild(mirror); 
            
            mirror.scrollTop = textarea.scrollTop;
            mirror.scrollLeft = textarea.scrollLeft;

            const caretRect = caretSpan.getBoundingClientRect();
            const mirrorRect = mirror.getBoundingClientRect();

            const paddingLeft = parseFloat(style.paddingLeft);
            const x = (caretRect.left - mirrorRect.left) + mirror.scrollLeft - paddingLeft;
            
            const paddingTop = parseFloat(style.paddingTop);
            const y = (caretRect.top - mirrorRect.top) + mirror.scrollTop - paddingTop;
            
            document.body.removeChild(mirror);

            return { x: x, y: y, height: caretRect.height }; 
        }

        /**
         * å—ä¿¡ã—ãŸã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’ç”»é¢ã«è¡¨ç¤º/æ›´æ–°ã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
         */
        function updateRemoteCursor(data) {
            const { room, nickname, isText, position, tool, penColor, penWidth } = data;
            const color = getColorForNickname(nickname);
            
            let mouseContainer, textContainer, textarea;

            if (room === 'free') {
                mouseContainer = drawingMouseCursorContainer;
            } else if (room === 'novel') {
                mouseContainer = novelMouseCursorContainer;
                textContainer = novelTextCursorContainer;
                textarea = novelTextarea;
            } else if (room === 'music') {
                mouseContainer = lyricsMouseCursorContainer;
                textContainer = lyricsTextCursorContainer;
                textarea = lyricsTextarea;
            }
            
            const mouseId = `mouse-cursor-${nickname}`;
            const textId = `text-cursor-${nickname}`;

            if (!remoteCursors.has(nickname)) {
                const mouseCursor = createCursorElement(mouseId, mouseContainer, nickname, color, 'mouse-cursor');
                const textCursor = (room === 'novel' || room === 'music') ? createCursorElement(textId, textContainer, nickname, color, 'text-cursor') : null;
                remoteCursors.set(nickname, { mouseCursor, textCursor });
            }
            
            const { mouseCursor, textCursor } = remoteCursors.get(nickname);
            
            // ã‚«ãƒ¼ã‚½ãƒ«è¦ç´ ã‚’ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ ã®ã‚³ãƒ³ãƒ†ãƒŠã«ç§»å‹•ã•ã›ã‚‹
            if (mouseCursor.parentElement !== mouseContainer) {
                 mouseContainer.appendChild(mouseCursor);
            }
            if (textCursor && textCursor.parentElement !== textContainer) {
                 textContainer.appendChild(textCursor);
            }

            // ----------------------------------------------------
            // ãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ¼ã‚½ãƒ«ï¼ˆå°èª¬/éŸ³æ¥½ãƒ«ãƒ¼ãƒ ï¼‰ã®æ›´æ–°
            // ----------------------------------------------------
            if (isText && textCursor && typeof position === 'number') {
                mouseCursor.style.display = 'none'; // ãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ¼ã‚½ãƒ«æœ‰åŠ¹æ™‚ã¯ãƒã‚¦ã‚¹éè¡¨ç¤º

                if (position === -1) {
                    textCursor.style.display = 'none';
                    return;
                }
                
                // åº§æ¨™è¨ˆç®—
                const safePosition = Math.min(position, textarea.value.length);
                const coords = getTextareaCaretPosition(textarea, safePosition); 
                
                if (coords) {
                    textCursor.style.left = `${coords.x}px`;
                    textCursor.style.top = `${coords.y}px`;
                    textCursor.style.backgroundColor = color;
                    textCursor.style.height = `${coords.height}px`; // è¡Œã®é«˜ã•ã«åˆã‚ã›ã‚‹
                    textCursor.style.display = 'block';
                    
                    textCursor.querySelector('.remote-cursor-label').style.backgroundColor = color;
                } else {
                    textCursor.style.display = 'none';
                }
            } 
            
            // ----------------------------------------------------
            // ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ï¼ˆå…¨ãƒ«ãƒ¼ãƒ ï¼‰ã®æ›´æ–°
            // ----------------------------------------------------
            else if (!isText) { 
                if (textCursor) textCursor.style.display = 'none'; // ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«æœ‰åŠ¹æ™‚ã¯ãƒ†ã‚­ã‚¹ãƒˆéè¡¨ç¤º
                
                if (position && position.x !== undefined && position.y !== undefined && position.x >= 0) {
                    
                    mouseCursor.style.color = color;
                    mouseCursor.style.left = `${position.x}px`;
                    mouseCursor.style.top = `${position.y}px`;
                    mouseCursor.style.display = 'block';

                    if (room === 'free') {
                        // æç”»ãƒ«ãƒ¼ãƒ : ãƒ–ãƒ©ã‚·ã‚µã‚¤ã‚ºè¡¨ç¤º
                        const size = penWidth || 10;
                        mouseCursor.style.backgroundColor = 'transparent';
                        mouseCursor.style.border = `2px solid ${tool === 'pen' ? penColor : '#FF0000'}`;
                        mouseCursor.style.width = `${size}px`;
                        mouseCursor.style.height = `${size}px`;
                        mouseCursor.style.margin = `-${size / 2}px 0 0 -${size / 2}px`;
                        mouseCursor.classList.add('draw-tool');
                    } else {
                        // ãƒ†ã‚­ã‚¹ãƒˆãƒ«ãƒ¼ãƒ  (ãƒã‚¦ã‚¹ãƒ¢ãƒ¼ãƒ‰): æ¨™æº–ãƒã‚¤ãƒ³ã‚¿ãƒ¼
                        mouseCursor.style.backgroundColor = 'transparent';
                        mouseCursor.style.border = `6px 0 6px 8px solid ${color}`;
                        mouseCursor.style.width = '0';
                        mouseCursor.style.height = '0';
                        mouseCursor.style.margin = '0';
                        mouseCursor.classList.remove('draw-tool');
                    }
                    mouseCursor.querySelector('.remote-cursor-label').style.backgroundColor = color;
                } else {
                    // åº§æ¨™ãŒãªã„ã€ã¾ãŸã¯-1,-1ã®å ´åˆã¯éè¡¨ç¤º
                    mouseCursor.style.display = 'none';
                }
            }
        }
        
        function sendCursorUpdate(room, data = {}) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'cursor_update',
                    room: room,
                    nickname: nickname,
                    tool: currentTool,
                    penColor: currentPenColor,
                    penWidth: currentPenWidth,
                    ...data 
                }));
            }
        }

        function sendTextUpdate(room, textarea) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                 // éŸ³æ¥½ãƒ«ãƒ¼ãƒ ã®å ´åˆã€URLã¨æ­Œè©ã‚’çµåˆã—ã¦é€ä¿¡
                let contentToSend = textarea.value;
                if (room === 'music') {
                    const urlContent = musicUrls.map(url => `[URL: ${url}]`).join('\n') + '\n\n';
                    contentToSend = urlContent + `[æ­Œè©/ã‚¢ã‚¤ãƒ‡ã‚¢]:\n` + textarea.value;
                }

                ws.send(JSON.stringify({
                    type: 'content_update',
                    room: room,
                    nickname: nickname,
                    content: contentToSend 
                }));
            }
        }


        // =========================================================
        // â˜…â˜…â˜… 3. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (è¿½å¾“ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åˆ¶å¾¡) â˜…â˜…â˜…
        // =========================================================

        function setupGlobalMouseTracking() {
            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢å¤–ã®ã‚¨ãƒªã‚¢ã§ã®ãƒã‚¦ã‚¹ãƒ ãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆã®ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚° (isText: false)
            const trackMouse = (room, element) => {
                element.addEventListener('mousemove', (e) => {
                    if (currentRoom === room) {
                        const rect = element.getBoundingClientRect();
                        // ã‚«ãƒ¼ã‚½ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã®å·¦ä¸Šã‚’ (0,0) ã¨ã—ãŸç›¸å¯¾åº§æ¨™ã‚’é€ä¿¡
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        sendCursorUpdate(room, { isText: false, position: { x: x, y: y } });
                    }
                });
                // ãƒã‚¦ã‚¹ã‚¢ã‚¦ãƒˆã§åº§æ¨™ã‚’ã‚¯ãƒªã‚¢
                element.addEventListener('mouseout', () => {
                     if (currentRoom === room) {
                         sendCursorUpdate(room, { isText: false, position: { x: -1, y: -1 } });
                     }
                });
            };

            // ãƒ•ãƒªãƒ¼ãƒ«ãƒ¼ãƒ å…¨ä½“ã‚’ãƒˆãƒ©ãƒƒã‚¯
            trackMouse('free', drawingRoomContent);
            // å°èª¬/éŸ³æ¥½ãƒ«ãƒ¼ãƒ ã®è¦ªè¦ç´ å…¨ä½“ã‚’ãƒˆãƒ©ãƒƒã‚¯
            trackMouse('novel', novelRoomContent);
            trackMouse('music', musicRoomContent); 
        }

        function setupTextareaTracking(textarea, room) {
            
            // ã€ä¿®æ­£ç‚¹ã€‘ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢å†…ã§ã®ãƒã‚¦ã‚¹ãƒ ãƒ¼ãƒ–ï¼šãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ã‚’è¿½å¾“ã•ã›ã‚‹ (isText: false)
            textarea.addEventListener('mousemove', (e) => {
                 if (currentRoom === room) {
                    const rect = textarea.getBoundingClientRect();
                    // ã‚«ãƒ¼ã‚½ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã¯ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°(15px)ã®å ´æ‰€ã‹ã‚‰å§‹ã¾ã‚‹
                    // e.clientX - rect.left ã¯ padding-left ã®æ‰‹å‰ã‹ã‚‰å§‹ã¾ã‚‹ã®ã§ã€15pxã‚’åŠ ç®—ã—ã¦ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ç›¸å¯¾åº§æ¨™ã«ã™ã‚‹
                    const x = (e.clientX - rect.left) + 15; 
                    const y = (e.clientY - rect.top) + 15;
                    sendCursorUpdate(room, { isText: false, position: { x: x, y: y } });
                 }
            });

            // æ–‡å­—å…¥åŠ›æ™‚ï¼šã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ›´æ–°ã‚’**å³æ™‚**é€ä¿¡ã—ã€ç¸¦ç·šã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚‚é€ä¿¡ (isText: true)
            textarea.addEventListener('input', () => {
                sendTextUpdate(room, textarea); 
                sendCursorUpdate(room, { isText: true, position: textarea.selectionStart }); 
            });
            
            // ã‚¯ãƒªãƒƒã‚¯ã€ã‚­ãƒ¼ã‚¢ãƒƒãƒ—ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ï¼šç¸¦ç·šã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã®ã¿é€ä¿¡ (isText: true)
            textarea.addEventListener('click', () => sendCursorUpdate(room, { isText: true, position: textarea.selectionStart }));
            textarea.addEventListener('keyup', (e) => {
                sendCursorUpdate(room, { isText: true, position: textarea.selectionStart });
            });
            textarea.addEventListener('scroll', () => sendCursorUpdate(room, { isText: true, position: textarea.selectionStart })); 
            
            // ãƒã‚¦ã‚¹ã‚¢ã‚¦ãƒˆæ™‚ã€ã‚«ãƒ¼ã‚½ãƒ«è¡¨ç¤ºã‚’è§£é™¤
            textarea.addEventListener('mouseout', () => {
                // 1. ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹ (x:-1, y:-1)
                sendCursorUpdate(room, { isText: false, position: { x: -1, y: -1 } }); 
                // 2. ãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ¼ã‚½ãƒ«ã‚‚éè¡¨ç¤ºã«ã™ã‚‹ (position: -1)
                sendCursorUpdate(room, { isText: true, position: -1 });
            });
        }

        setupTextareaTracking(novelTextarea, 'novel');
        setupTextareaTracking(lyricsTextarea, 'music');


        // =========================================================
        // â˜…â˜…â˜… 4. å„ãƒ«ãƒ¼ãƒ ã®å€‹åˆ¥ãƒ­ã‚¸ãƒƒã‚¯ (æç”»/éŸ³æ¥½URL) â˜…â˜…â˜…
        // =========================================================
        
        // --- æç”»ãƒ­ã‚¸ãƒƒã‚¯ ---
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        ctx.lineCap = 'round';
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, canvas.width, canvas.height); 
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        function setTool(tool) {
            currentTool = tool;
            penToolButton.classList.remove('active');
            eraserToolButton.classList.remove('active');
            if (tool === 'pen') {
                penToolButton.classList.add('active');
                ctx.globalCompositeOperation = 'source-over'; 
            } else if (tool === 'eraser') {
                eraserToolButton.classList.add('active');
                ctx.globalCompositeOperation = 'destination-out'; 
            }
            // ãƒ„ãƒ¼ãƒ«å¤‰æ›´æ™‚ã«ã‚‚ã‚«ãƒ¼ã‚½ãƒ«æƒ…å ±ã‚’é€ä¿¡
            sendCursorUpdate('free', { isText: false, position: { x: lastX, y: lastY } });
        }

        penToolButton.addEventListener('click', () => setTool('pen'));
        eraserToolButton.addEventListener('click', () => setTool('eraser'));
        clearCanvasButton.addEventListener('click', () => {
             ctx.fillStyle = '#fff';
             ctx.fillRect(0, 0, canvas.width, canvas.height);
             if (ws && ws.readyState === WebSocket.OPEN) {
                 ws.send(JSON.stringify({ type: 'clear', room: 'free' }));
             }
        });
        setTool('pen'); 

        function drawLine(x0, y0, x1, y1, color, width, tool) {
            const originalCompositeOperation = ctx.globalCompositeOperation;
            const originalStrokeStyle = ctx.strokeStyle;
            const originalLineWidth = ctx.lineWidth;
            
            ctx.globalCompositeOperation = tool === 'eraser' ? 'destination-out' : 'source-over';
            
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = width;
            ctx.moveTo(x0, y0);
            ctx.lineTo(x1, y1);
            ctx.stroke();
            
            ctx.strokeStyle = originalStrokeStyle;
            ctx.lineWidth = originalLineWidth;
            ctx.globalCompositeOperation = originalCompositeOperation;
        }

        function draw(e) {
            if (currentRoom !== 'free') return;
            const [currentX, currentY] = [e.offsetX, e.offsetY];

            if (!isDrawing) {
                 [lastX, lastY] = [currentX, currentY];
                 return;
            }
            
            const strokeColor = currentTool === 'eraser' ? 'rgba(0,0,0,1)' : currentPenColor; 
            
            // ãƒ­ãƒ¼ã‚«ãƒ«æç”»
            drawLine(lastX, lastY, currentX, currentY, strokeColor, currentPenWidth, currentTool);

            if (ws && ws.readyState === WebSocket.OPEN) {
                // ã‚µãƒ¼ãƒãƒ¼ã«æç”»ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
                ws.send(JSON.stringify({
                    type: 'draw',
                    room: 'free',
                    x0: lastX, y0: lastY, x1: currentX, y1: currentY, 
                    color: strokeColor, width: currentPenWidth, tool: currentTool
                }));
            }
            
            [lastX, lastY] = [currentX, currentY];
        }

        canvas.addEventListener('mousedown', (e) => {
            if (currentRoom !== 'free') return;
            isDrawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];
            ctx.globalCompositeOperation = currentTool === 'pen' ? 'source-over' : 'destination-out'; 
        });
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', () => isDrawing = false);
        canvas.addEventListener('mouseout', () => isDrawing = false);
        
        penColorInput.addEventListener('change', (e) => { 
            currentPenColor = e.target.value; 
            // æç”»ãƒ„ãƒ¼ãƒ«ã‚«ãƒ¼ã‚½ãƒ«ã®è‰²ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã«ã‚«ãƒ¼ã‚½ãƒ«æƒ…å ±ã‚’å†é€ä¿¡
            sendCursorUpdate('free', { isText: false, position: { x: lastX, y: lastY }, penColor: currentPenColor });
        });
        penWidthInput.addEventListener('input', (e) => {
            currentPenWidth = parseInt(e.target.value);
            widthValueSpan.textContent = currentPenWidth;
            // æç”»ãƒ„ãƒ¼ãƒ«ã‚«ãƒ¼ã‚½ãƒ«ã®ã‚µã‚¤ã‚ºã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã«ã‚«ãƒ¼ã‚½ãƒ«æƒ…å ±ã‚’å†é€ä¿¡
            sendCursorUpdate('free', { isText: false, position: { x: lastX, y: lastY }, penWidth: currentPenWidth });
        });

        function handleReceivedDrawing(data) {
             if (data.type === 'clear') {
                ctx.fillStyle = '#fff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                return;
            }
            if (data.type === 'draw') {
                drawLine(data.x0, data.y0, data.x1, data.y1, data.color, data.width, data.tool);
            }
        }
        
        function redrawCanvas(history) {
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (history) {
                 history.forEach(line => {
                    drawLine(line.x0, line.y0, line.x1, line.y1, line.color, line.width, line.tool);
                });
            }
        }
        
        // --- éŸ³æ¥½ãƒ«ãƒ¼ãƒ  (URLä¸¦ã¹æ›¿ãˆ) ãƒ­ã‚¸ãƒƒã‚¯ ---
        
        function renderMusicUrls() {
            musicUrlsList.innerHTML = '';
            musicUrls.forEach((url, index) => {
                const li = document.createElement('li');
                li.draggable = true;
                li.dataset.index = index;
                li.textContent = url.length > 50 ? url.substring(0, 50) + '...' : url;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-url';
                removeBtn.textContent = 'å‰Šé™¤';
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // ãƒ‰ãƒ©ãƒƒã‚°ã¨ãƒãƒƒãƒ†ã‚£ãƒ³ã‚°ã—ãªã„ã‚ˆã†ã«
                    removeMusicUrl(index);
                });
                
                li.appendChild(removeBtn);
                musicUrlsList.appendChild(li);
            });
            setupDragAndDrop();
        }

        addMusicUrlButton.addEventListener('click', () => {
            const url = newMusicUrlInput.value.trim();
            if (url) {
                musicUrls.push(url);
                newMusicUrlInput.value = '';
                sendTextUpdate('music', lyricsTextarea); // URLãƒªã‚¹ãƒˆå¤‰æ›´ã¯ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°ã¨ã—ã¦é€ä¿¡
            }
        });
        
        function removeMusicUrl(index) {
            musicUrls.splice(index, 1);
            sendTextUpdate('music', lyricsTextarea); // URLãƒªã‚¹ãƒˆå¤‰æ›´ã¯ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°ã¨ã—ã¦é€ä¿¡
        }
        
        function setupDragAndDrop() {
            let dragStartIndex;

            musicUrlsList.querySelectorAll('li').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    dragStartIndex = parseInt(item.dataset.index);
                    e.dataTransfer.setData('text/plain', dragStartIndex);
                    setTimeout(() => item.classList.add('dragging'), 0);
                });

                item.addEventListener('dragend', () => item.classList.remove('dragging'));

                item.addEventListener('dragover', (e) => {
                    e.preventDefault(); 
                    const draggingItem = document.querySelector('.dragging');
                    if (draggingItem && draggingItem !== item) {
                        const boundingBox = item.getBoundingClientRect();
                        const offset = boundingBox.y + boundingBox.height / 2;
                        
                        if (e.clientY > offset) {
                            musicUrlsList.insertBefore(draggingItem, item.nextSibling);
                        } else {
                            musicUrlsList.insertBefore(draggingItem, item);
                        }
                    }
                });

                musicUrlsList.addEventListener('drop', (e) => {
                    e.preventDefault();
                    
                    const newUrls = Array.from(musicUrlsList.children).map(li => {
                        // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’é™¤å¤–ã—ã¦URLã‚’æŠ½å‡º
                        return li.textContent.replace(/å‰Šé™¤$/, '').trim();
                    });
                    
                    musicUrls = newUrls;
                    sendTextUpdate('music', lyricsTextarea); // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å¾Œã®ãƒªã‚¹ãƒˆå¤‰æ›´ã‚‚é€ä¿¡
                });
            });
        }
        
        // =========================================================
        // â˜…â˜…â˜… 5. å…±é€šæ©Ÿèƒ½ï¼šãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã¨èª­ã¿è¾¼ã¿ (ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡) â˜…â˜…â˜…
        // =========================================================
        
        function getCurrentRoom() { return currentRoom; }

        async function saveTextData(room, content) {
            // ä»®ã®ã‚µãƒ¼ãƒãƒ¼ãƒ‘ã‚¹
            const res = await fetch('/api/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room: room, content: content })
            });
            if (res.ok) { console.log(`${room}ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`); } else { console.error(`${room}ã®ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`); }
        }


        // ----------------------------------------------------
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (ä¿å­˜ãƒ»å…¬é–‹)
        // ----------------------------------------------------

        saveButton.addEventListener('click', async () => {
            const room = getCurrentRoom();
            
            let contentToSave = '';

            if (room === 'free') {
                 // ã‚µãƒ¼ãƒãƒ¼ã¯å±¥æ­´ã§ç®¡ç†ã—ã¦ã„ã‚‹ãŸã‚ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ä¸€æ™‚ä¿å­˜ãƒœã‚¿ãƒ³ã¯ãƒ†ã‚­ã‚¹ãƒˆãƒ«ãƒ¼ãƒ ã®ã¿æœ‰åŠ¹ã«ã™ã‚‹
                publishStatus.textContent = 'æç”»ãƒ«ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã¯æç”»ã¨åŒæ™‚ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚';
                publishStatus.style.color = 'gray';
                setTimeout(() => { publishStatus.textContent = ''; }, 3000);
                return;
            } else if (room === 'novel') {
                contentToSave = novelTextarea.value;
            } else if (room === 'music') {
                // URLã¨æ­Œè©ã‚’çµåˆã—ã¦ä¿å­˜
                const urlContent = musicUrls.map(url => `[URL: ${url}]`).join('\n') + '\n\n';
                contentToSave = urlContent + `[æ­Œè©/ã‚¢ã‚¤ãƒ‡ã‚¢]:\n` + lyricsTextarea.value;
            }
            
            if (contentToSave) {
                 await saveTextData(room, contentToSave);
                 publishStatus.textContent = 'ä¸€æ™‚ä¿å­˜ã—ã¾ã—ãŸã€‚';
                 publishStatus.style.color = '#2196F3';
                 setTimeout(() => { publishStatus.textContent = ''; }, 3000);
            }
        });

        publishButton.addEventListener('click', async () => {
            const room = getCurrentRoom();
            const title = workTitleInput.value.trim();
            
            let content = '';
            let contentType = '';
            
            if (!title) {
                publishStatus.textContent = 'ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                publishStatus.style.color = 'red';
                return;
            }

            if (room === 'free') {
                content = canvas.toDataURL('image/png');
                contentType = 'image';
            } else if (room === 'novel') {
                content = `ä½œè€…: ${nickname}\n\n${novelTextarea.value}`;
                contentType = 'text';
            } else if (room === 'music') {
                const urlLines = musicUrls.map(url => `[æ¥½è­œ/URL]: ${url}`).join('\n');
                const lyrics = lyricsTextarea.value;
                content = `ä½œè€…: ${nickname}\n${urlLines}\n\n[æ­Œè©/ã‚¢ã‚¤ãƒ‡ã‚¢]:\n${lyrics}`;
                contentType = 'text'; 
            }

            // API: /api/publish
            const res = await fetch('/api/publish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, room, content, content_type: contentType, nickname: nickname }) 
            });

            if (res.ok) {
                publishStatus.textContent = `ä½œå“ã€Œ${title}ã€ã‚’å…¬é–‹ã—ã¾ã—ãŸï¼`;
                publishStatus.style.color = 'green';
                workTitleInput.value = '';
            } else {
                publishStatus.textContent = 'ä½œå“ã®å…¬é–‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                publishStatus.style.color = 'red';
            }
        });

    </script>
</body>
</html>
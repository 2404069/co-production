<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>å…±åŒåˆ¶ä½œãƒ„ãƒ¼ãƒ«</title>
    <style>
        /* --- å…¨ä½“åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« --- */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        h1 {
            color: #4CAF50;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* --- èµ·å‹•åˆ¶å¾¡ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #setup-screen {
            padding: 30px;
            border: 2px solid #ccc;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            background-color: #e8f5e9;
        }
        #setup-screen input[type="text"] {
            padding: 10px;
            width: 80%;
            max-width: 300px;
            margin: 10px 0 20px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #join-button {
            padding: 12px 25px;
            font-size: 18px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #join-button:hover {
            background-color: #45a049;
        }

        /* --- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± --- */
        .user-info {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px dashed #ccc;
            border-radius: 4px;
            display: inline-block;
        }
        
        /* --- æç”»ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« --- */
        .drawing-controls {
            display: none; 
            gap: 20px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        .tool-button.active {
            border: 2px solid #4CAF50;
            background-color: #e8f5e9;
        }

        /* --- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ --- */
        .room-content {
            border: 2px solid #ccc;
            border-radius: 4px;
            padding: 0; 
            min-height: 600px;
            margin-bottom: 20px;
            background-color: #fff;
            position: relative; 
            overflow: hidden;
        }
        #drawingCanvas {
            cursor: crosshair;
            display: block;
        }
        
        /* --- ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ«ã®èª¿æ•´ --- */
        textarea {
            width: 100%;
            height: 550px;
            border: none;
            padding: 15px; 
            box-sizing: border-box;
            resize: none;
            font-size: 16px;
            background-color: white;
            position: relative;
            z-index: 2; 
            line-height: 1.5; 
            font-family: monospace; 
        }
        #lyricsTextarea {
            height: 300px; 
        }

        /* ======================================= */
        /* â˜…â˜…â˜… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ã‚½ãƒ«åæ˜ ç”¨ã®CSS â˜…â˜…â˜… */
        /* ======================================= */
        
        .mouse-cursor-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; 
            z-index: 10; 
        }
        
        .text-cursor-container {
            /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°(15px)ã¨åˆã‚ã›ã‚‹ */
            position: absolute; 
            top: 15px; /* textarea padding-top */
            left: 15px; /* textarea padding-left */
            width: calc(100% - 30px);
            height: calc(100% - 30px); 
            pointer-events: none; 
            z-index: 3; 
            overflow: hidden; 
        }
        
        .remote-cursor {
            position: absolute;
            pointer-events: none;
            z-index: 4;
            transition: all 0.1s; 
            display: none; 
        }

        .mouse-cursor {
            border-radius: 50%;
            width: 10px;
            height: 10px;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            margin-top: -5px;
            margin-left: -5px;
            background-color: transparent;
        }

        .text-cursor {
            border: none;
            width: 2px;
            height: 1.5em; 
            animation: blink 1s step-end infinite;
            margin: 0;
            box-shadow: none;
        }

        .remote-cursor-label {
            position: absolute;
            top: -1.5em; 
            left: 0;
            font-size: 0.7em;
            padding: 2px 5px;
            border-radius: 3px;
            color: white;
            white-space: nowrap;
            z-index: 5;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }
        
        /* --- éŸ³æ¥½ãƒ«ãƒ¼ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯çœç•¥ --- */
        .music-section {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            position: relative; 
        }
        #music-urls-list {
            list-style: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
        }
        #music-urls-list li {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: grab;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff;
        }
        #music-urls-list li:last-child {
            border-bottom: none;
        }
        .remove-url {
            background: #ff5555;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        /* --- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã¯çœç•¥ --- */
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            align-items: center;
        }
        button {
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        #save-button {
            background-color: #2196F3;
            color: white;
        }
        #publish-button {
            background-color: #FF9800;
            color: white;
        }
        #work-title {
            padding: 10px;
            flex-grow: 1;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .status-message {
            margin-left: 15px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ–Šï¸ å…±åŒåˆ¶ä½œãƒ„ãƒ¼ãƒ«</h1>

        <div id="setup-screen">
            <h2>ã‚ˆã†ã“ãï¼ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨ãƒ«ãƒ¼ãƒ ã‚’é¸ã‚“ã§ãã ã•ã„</h2>
            <label for="initialNickname">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ :</label>
            <input type="text" id="initialNickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›" value="åç„¡ã—ã•ã‚“">
            
            <div id="initial-room-selection" class="room-selection" style="display: inline-block;">
                <input type="radio" id="initial-free-room" name="initial-room" value="free" checked>
                <label for="initial-free-room">ãƒ•ãƒªãƒ¼ãƒ«ãƒ¼ãƒ  (æç”»)</label>
                <input type="radio" id="initial-novel-room" name="initial-room" value="novel">
                <label for="initial-novel-room">å°èª¬ãƒ«ãƒ¼ãƒ </label>
                <input type="radio" id="initial-music-room" name="initial-room" value="music">
                <label for="initial-music-room">éŸ³æ¥½ãƒ«ãƒ¼ãƒ </label>
            </div>
            <br>
            <button id="join-button">ãƒ«ãƒ¼ãƒ ã«å‚åŠ ã™ã‚‹</button>
        </div>

        <div id="main-content" style="display: none;">
            
            <div class="user-info">
                <label>ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ :</label>
                <span id="currentRoomDisplay"></span>
                <label style="margin-left: 20px;">ç¾åœ¨ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ :</label>
                <span id="currentNicknameDisplay"></span>
            </div>

            <div id="drawing-room" class="room-content"> 
                <div class="drawing-controls" id="drawing-controls">
                    <label>ãƒ„ãƒ¼ãƒ«:</label>
                    <button id="penTool" class="tool-button active">ğŸ–Šï¸ ãƒšãƒ³</button>
                    <button id="eraserTool" class="tool-button">ğŸ§¹ æ¶ˆã—ã‚´ãƒ </button>
                    
                    <label for="penColor">è‰²:</label>
                    <input type="color" id="penColor" value="#000000">
                    <label for="penWidth">å¤ªã•:</label>
                    <input type="range" id="penWidth" min="1" max="50" value="5">
                    <span id="widthValue">5</span>px
                    <button id="clearCanvas">ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢</button>
                </div>
                <div class="room-content" id="drawing-room-content">
                    <div id="drawing-mouse-cursor-container" class="mouse-cursor-container"></div>
                    <canvas id="drawingCanvas" width="1000" height="600"></canvas>
                </div>
            </div>
            
            <div id="novel-room" class="room-content">
                <div id="novel-mouse-cursor-container" class="mouse-cursor-container"></div>
                <div id="novel-text-cursor-container" class="text-cursor-container"></div>
                <textarea id="novelTextarea" placeholder="å°èª¬ã‚’æ›¸ãã¾ã—ã‚‡ã†..."></textarea>
            </div>
            
            <div id="music-room">
                
                <div class="music-section room-content">
                    <h3>ğŸ“ æ­Œè©ãƒ»ã‚¢ã‚¤ãƒ‡ã‚¢</h3>
                    <div id="lyrics-mouse-cursor-container" class="mouse-cursor-container"></div>
                    <div id="lyrics-text-cursor-container" class="text-cursor-container"></div>
                    <textarea id="lyricsTextarea" placeholder="æ­Œè©ã€ã‚³ãƒ¼ãƒ‰é€²è¡Œã€åˆ¶ä½œã‚¢ã‚¤ãƒ‡ã‚¢ãªã©ã‚’æ›¸ãã¾ã—ã‚‡ã†..."></textarea>
                </div>

                <div class="music-section">
                    <h3>ğŸ¶ éŸ³æºURLãƒªã‚¹ãƒˆ (ä¸¦ã¹æ›¿ãˆå¯èƒ½)</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="newMusicUrl" placeholder="æ–°ã—ã„éŸ³æºã®URLã¾ãŸã¯åŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰ã‚’è²¼ä»˜" style="flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <button id="addMusicUrl" style="background-color: #3498db; color: white;">è¿½åŠ </button>
                    </div>
                    <ul id="music-urls-list">
                        </ul>
                </div>
            </div>

            <div class="controls">
                <input type="text" id="work-title" placeholder="ä½œå“ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›" required>
                <button id="save-button">ğŸ’¾ ä¸€æ™‚ä¿å­˜</button>
                <button id="publish-button">ğŸ“¢ ä½œå“ã‚’å…¬é–‹</button>
                <span id="publish-status" class="status-message"></span>
            </div>

            <div class="view-works">
                <a href="/published.html">å…¬é–‹ä½œå“ä¸€è¦§ã‚’è¦‹ã‚‹ â†’</a>
            </div>
        </div>
    </div>

    <script>
        // ã€é‡è¦ã€‘DOMæ“ä½œã«å¿…è¦ãªè¦ç´ ã®å–å¾—
        const setupScreen = document.getElementById('setup-screen');
        const mainContent = document.getElementById('main-content');
        const joinButton = document.getElementById('join-button');
        const initialNicknameInput = document.getElementById('initialNickname');
        const currentNicknameDisplay = document.getElementById('currentNicknameDisplay');
        const currentRoomDisplay = document.getElementById('currentRoomDisplay');

        const drawingRoom = document.getElementById('drawing-room');
        const novelRoom = document.getElementById('novel-room');
        const musicRoom = document.getElementById('music-room');
        const novelTextarea = document.getElementById('novelTextarea');
        const lyricsTextarea = document.getElementById('lyricsTextarea');
        
        const drawingRoomContent = document.getElementById('drawing-room-content');
        const novelRoomContent = document.getElementById('novel-room');
        const musicRoomContent = document.getElementById('music-room').querySelector('.music-section:first-child'); 
        
        const drawingMouseCursorContainer = document.getElementById('drawing-mouse-cursor-container');
        const novelMouseCursorContainer = document.getElementById('novel-mouse-cursor-container');
        const lyricsMouseCursorContainer = document.getElementById('lyrics-mouse-cursor-container');
        
        const novelTextCursorContainer = document.getElementById('novel-text-cursor-container');
        const lyricsTextCursorContainer = document.getElementById('lyrics-text-cursor-container');
        
        // æç”»ãƒ„ãƒ¼ãƒ«é–¢é€£
        const penToolButton = document.getElementById('penTool');
        const eraserToolButton = document.getElementById('eraserTool');
        const penColorInput = document.getElementById('penColor');
        const penWidthInput = document.getElementById('penWidth');
        const widthValueSpan = document.getElementById('widthValue');
        const clearCanvasButton = document.getElementById('clearCanvas');
        
        // éŸ³æ¥½ãƒ«ãƒ¼ãƒ é–¢é€£
        const newMusicUrlInput = document.getElementById('newMusicUrl');
        const addMusicUrlButton = document.getElementById('addMusicUrl');
        const musicUrlsList = document.getElementById('music-urls-list');

        // ä¿å­˜ãƒ»å…¬é–‹é–¢é€£
        const saveButton = document.getElementById('save-button');
        const publishButton = document.getElementById('publish-button');
        const workTitleInput = document.getElementById('work-title');
        const publishStatus = document.getElementById('publish-status');
        
        // WebSocketé–¢é€£ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let ws = null;
        let currentRoom = ''; 
        let nickname = '';
        let musicUrls = []; 
        const cursorColors = {}; 
        let currentPenColor = '#000000';
        let currentPenWidth = 5;
        let currentTool = 'pen'; 

        // =========================================================
        // â˜…â˜…â˜… 1. èµ·å‹•åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
        // =========================================================

        joinButton.addEventListener('click', () => {
            const initialNickname = initialNicknameInput.value.trim() || 'åç„¡ã—ã•ã‚“';
            const initialRoomElement = document.querySelector('input[name="initial-room"]:checked');
            const initialRoom = initialRoomElement ? initialRoomElement.value : 'free';
            
            if (initialNickname) {
                nickname = initialNickname;
                currentRoom = initialRoom;
                currentNicknameDisplay.textContent = nickname;
                currentRoomDisplay.textContent = getRoomName(currentRoom);
                
                setupScreen.style.display = 'none';
                mainContent.style.display = 'block';

                initializeWebSocket(initialRoom);
            }
        });

        function getRoomName(room) {
            if (room === 'free') return 'ãƒ•ãƒªãƒ¼ãƒ«ãƒ¼ãƒ  (æç”»)';
            if (room === 'novel') return 'å°èª¬ãƒ«ãƒ¼ãƒ ';
            if (room === 'music') return 'éŸ³æ¥½ãƒ«ãƒ¼ãƒ ';
            return room;
        }

        function initializeWebSocket(initialRoom) {
            // ã€é‡è¦ã€‘ã‚µãƒ¼ãƒãƒ¼ã‚’å…¬é–‹ã™ã‚‹éš›ã¯ã€ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã€Œå…¬é–‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã¾ãŸã¯ã€Œãƒ‰ãƒ¡ã‚¤ãƒ³åã€ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚
            // ä¾‹: ws = new WebSocket('ws://203.0.113.42:3000');
            // â˜…â˜…â˜… å¤–éƒ¨å…¬é–‹ç”¨ä¿®æ­£æ¸ˆã¿: ä»¥ä¸‹ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ã‚µãƒ¼ãƒãƒ¼ã®å…¬é–‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ â˜…â˜…â˜…
            ws = new WebSocket('ws://0.0.0.0:3000'); 
            
            ws.onopen = () => {
                console.log('WebSocket connection established.');
                sendJoinRoom(initialRoom);
                loadInitialContent(initialRoom); 
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'content_update' && data.room === currentRoom) {
                        if (data.room === 'free') {
                            handleReceivedDrawing(data);
                        } else if (data.room === 'novel') {
                            novelTextarea.value = data.content;
                        } else if (data.room === 'music') {
                            lyricsTextarea.value = data.lyrics || ''; 
                            if (Array.isArray(data.urls)) {
                                musicUrls = data.urls;
                                renderMusicUrls();
                            }
                        }
                    } else if (data.type === 'cursor_update' && data.room === currentRoom) { 
                        if (data.nickname === nickname) return;
                        updateRemoteCursor(data.room, data.nickname, data.position, data.isText, data.tool, data.penColor, data.penWidth);
                    }
                } catch (e) {
                    console.error('WebSocket message handling error:', e);
                }
            };

            ws.onclose = () => {
                console.log('WebSocket connection closed.');
            };

            setupGlobalMouseTracking(); 
        }

        async function loadInitialContent(room) {
            // â˜…ã™ã¹ã¦ã®ãƒ«ãƒ¼ãƒ ã‚’ä¸€æ—¦éè¡¨ç¤ºã«ã—ã€é¸æŠã•ã‚ŒãŸãƒ«ãƒ¼ãƒ ã®ã¿è¡¨ç¤ºâ˜…
            drawingRoom.style.display = 'none';
            novelRoom.style.display = 'none';
            musicRoom.style.display = 'none';

            if (room === 'free') {
                drawingRoom.style.display = 'block';
                await loadDrawing();
                document.getElementById('drawing-controls').style.display = 'flex';
            } else if (room === 'novel') {
                novelRoom.style.display = 'block';
                novelTextarea.value = await loadTextData('novel');
            } else if (room === 'music') {
                musicRoom.style.display = 'block';
                const loadedData = await loadTextData('music');
                const [lyrics, urls] = parseMusicData(loadedData);
                lyricsTextarea.value = lyrics;
                musicUrls = urls;
                renderMusicUrls();
            }
        }
        
        function parseMusicData(data) {
            const urlRegex = /\[URL: (.*?)\]/g;
            let lyrics = data;
            const urls = [];
            let match;
            
            while ((match = urlRegex.exec(data)) !== null) {
                urls.push(match[1]);
                lyrics = lyrics.replace(match[0], '').trim();
            }
            return [lyrics.replace(/\[æ­Œè©\/ã‚¢ã‚¤ãƒ‡ã‚¢\]:\n/, '').trim(), urls];
        }

        // =========================================================
        // â˜…â˜…â˜… 2. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ã¨ã‚«ãƒ¼ã‚½ãƒ«ãƒ­ã‚¸ãƒƒã‚¯ (ã‚³ã‚¢æ©Ÿèƒ½) â˜…â˜…â˜…
        // =========================================================

        function sendJoinRoom(roomName) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'join_room',
                    room: roomName,
                    nickname: nickname
                }));
            }
        }

        /**
         * [NEW] éš ã—ãƒŸãƒ©ãƒ¼è¦ç´ ã‚’ä½¿ã£ã¦ã€textareaå†…ã®ã‚«ãƒ¼ã‚½ãƒ«ã®X, Yåº§æ¨™ã‚’è¨ˆç®—ã™ã‚‹
         * (textarea.getClientRects()ã®ä¸å®‰å®šã•ã‚’å›é¿ã™ã‚‹ãƒ­ãƒã‚¹ãƒˆãªæ‰‹æ³•)
         */
        function getTextareaCaretPosition(textarea, position) {
            // 1. ãƒŸãƒ©ãƒ¼è¦ç´ ã‚’ä½œæˆã—ã€textareaã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
            const mirror = document.createElement('div');
            const style = window.getComputedStyle(textarea);
            const textareaRect = textarea.getBoundingClientRect();

            // ãƒ†ã‚­ã‚¹ãƒˆã®æµã‚Œã«é–¢ã‚ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
            const styleProperties = ['fontFamily', 'fontSize', 'lineHeight', 'paddingTop', 'paddingRight', 'paddingBottom', 'paddingLeft', 'borderTopWidth', 'borderRightWidth', 'borderBottomWidth', 'borderLeftWidth', 'boxSizing'];
            styleProperties.forEach(prop => {
                mirror.style[prop] = style[prop];
            });

            // ãã®ä»–ã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«å¿…é ˆã®ã‚¹ã‚¿ã‚¤ãƒ«
            mirror.style.whiteSpace = 'pre-wrap';
            mirror.style.wordWrap = 'break-word';
            mirror.style.position = 'absolute';
            mirror.style.visibility = 'hidden';
            mirror.style.overflow = 'auto'; 
            mirror.style.width = textareaRect.width + 'px'; // widthã‚’æ­£ç¢ºã«åˆã‚ã›ã‚‹

            // 2. ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã§ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ†å‰²ã—ã€ã‚«ãƒ¼ã‚½ãƒ«ã‚’è¡¨ã™spanã‚’æŒ¿å…¥
            const content = textarea.value;
            const preText = content.substring(0, position);
            // ã‚¼ãƒ­å¹…ã‚¹ãƒšãƒ¼ã‚¹ã‚’æŒ¿å…¥ã—ã¦ã€ã‚«ãƒ¼ã‚½ãƒ«ã®é«˜ã•ã‚’ç¶­æŒã—ã¤ã¤ã€ãƒ†ã‚­ã‚¹ãƒˆãƒ•ãƒ­ãƒ¼ã‚’ä¹±ã•ãªã„
            const postText = content.substring(position); 

            // pre-text (ã‚«ãƒ¼ã‚½ãƒ«ã‚ˆã‚Šå‰ã®ãƒ†ã‚­ã‚¹ãƒˆ)
            const pre = document.createElement('span');
            pre.textContent = preText;
            
            // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’ç¤ºã™span (é«˜ã•/ä½ç½®ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®åŸºæº–)
            const caretSpan = document.createElement('span');
            // caretã®Rectã‚’å–å¾—ã™ã‚‹ãŸã‚ã€æœ€ä½é™ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒå¿…è¦
            caretSpan.textContent = '\u200B'; 

            // post-text
            const post = document.createElement('span');
            post.textContent = postText;

            mirror.appendChild(pre);
            mirror.appendChild(caretSpan);
            mirror.appendChild(post);

            document.body.appendChild(mirror); 
            
            // 3. ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’åˆã‚ã›ã‚‹ (åº§æ¨™è¨ˆç®—ã«å½±éŸ¿ã™ã‚‹)
            mirror.scrollTop = textarea.scrollTop;
            mirror.scrollLeft = textarea.scrollLeft;

            // 4. åº§æ¨™ã®è¨ˆç®—
            const caretRect = caretSpan.getBoundingClientRect();
            const mirrorRect = mirror.getBoundingClientRect();

            // Xåº§æ¨™: ãƒŸãƒ©ãƒ¼å†…ã®caretSpanã®å·¦ç«¯ - ãƒŸãƒ©ãƒ¼ã®å·¦ç«¯ - paddingLeft
            // (ã“ã‚Œã¯ã€ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°å†…å´ã‹ã‚‰ã®ç›¸å¯¾ä½ç½®)
            const paddingLeft = parseFloat(style.paddingLeft);
            const x = (caretRect.left - mirrorRect.left) + mirror.scrollLeft - paddingLeft;
            
            // Yåº§æ¨™: ãƒŸãƒ©ãƒ¼å†…ã®caretSpanã®ä¸Šç«¯ - ãƒŸãƒ©ãƒ¼ã®ä¸Šç«¯ - paddingTop
            const paddingTop = parseFloat(style.paddingTop);
            const y = (caretRect.top - mirrorRect.top) + mirror.scrollTop - paddingTop;

            // 5. ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            document.body.removeChild(mirror);

            // X, Yåº§æ¨™ã¯ã€Œtextareaã®content-boxã®å·¦ä¸Šã‚’(0,0)ã¨ã—ãŸä½ç½®ã€
            return { x: x, y: y }; 
        }

        // [æ³¨æ„] getTextCaretRects é–¢æ•°ã¯ä¸Šè¨˜ã®æ–°é–¢æ•°ã«ç½®ãæ›ãˆã‚‰ã‚ŒãŸãŸã‚ã€å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚
        
        /**
         * å—ä¿¡ã—ãŸã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’ç”»é¢ã«è¡¨ç¤º/æ›´æ–°ã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
         */
        function updateRemoteCursor(room, remoteNickname, position, isText, tool, penColor, penWidth) {
            if (!cursorColors[remoteNickname]) {
                cursorColors[remoteNickname] = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            }
            const color = cursorColors[remoteNickname];
            
            let mouseContainer;
            let textContainer;
            let textarea;

            if (room === 'free') {
                mouseContainer = drawingMouseCursorContainer;
            } else if (room === 'novel') {
                mouseContainer = novelMouseCursorContainer;
                textContainer = novelTextCursorContainer;
                textarea = novelTextarea;
            } else if (room === 'music') {
                mouseContainer = lyricsMouseCursorContainer;
                textContainer = lyricsTextCursorContainer;
                textarea = lyricsTextarea;
            }
            
            const mouseId = `mouse-cursor-${remoteNickname}`;
            const textId = `text-cursor-${remoteNickname}`;

            let mouseElement = document.getElementById(mouseId);
            if (!mouseElement) {
                mouseElement = createCursorElement(mouseId, mouseContainer, remoteNickname, color, 'mouse-cursor');
            }
            
            let textElement = (room === 'novel' || room === 'music') ? document.getElementById(textId) : null;
            if ((room === 'novel' || room === 'music') && !textElement) {
                 textElement = createCursorElement(textId, textContainer, remoteNickname, color, 'text-cursor');
            }
            
            // A. å°èª¬/éŸ³æ¥½ãƒ«ãƒ¼ãƒ ã§ ãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ¼ã‚½ãƒ«æƒ…å ±ãŒã‚ã‚‹å ´åˆ (ç¸¦ç·šè¿½å¾“)
            if ((room === 'novel' || room === 'music') && isText && typeof position === 'number') {
                mouseElement.style.display = 'none'; // â˜…ç¸¦ç·šãŒæœ‰åŠ¹ãªå ´åˆã¯ãƒã‚¦ã‚¹ã‚’éè¡¨ç¤ºã«ã™ã‚‹â˜…

                // positionãŒ -1 (mouseoutã§é€ä¿¡ã•ã‚Œã‚‹éè¡¨ç¤ºè¦æ±‚) ã®å ´åˆã¯å³åº§ã«éè¡¨ç¤ºã«ã™ã‚‹
                if (position === -1) {
                    textElement.style.display = 'none';
                    return;
                }
                
                // ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³å¯¾ç­–: ç¾åœ¨ã®ãƒ†ã‚­ã‚¹ãƒˆé•·ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ä½ç½®ã‚’ã‚¯ãƒ©ãƒ³ãƒ—ã™ã‚‹
                const safePosition = Math.min(position, textarea.value.length);

                // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: æ–°ã—ã„å®‰å®šã—ãŸåº§æ¨™å–å¾—é–¢æ•°ã‚’ä½¿ç”¨ â˜…â˜…â˜…
                const coords = getTextareaCaretPosition(textarea, safePosition); 
                
                // coords.x/y ã¯ textarea ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é ˜åŸŸã®å·¦ä¸Šã‚’ (0,0) ã¨ã—ãŸåº§æ¨™ã€‚
                // text-cursor-containerã‚‚ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é ˜åŸŸã®å·¦ä¸Š (15px, 15px) ã‹ã‚‰å§‹ã¾ã‚‹ãŸã‚ã€ã“ã®å€¤ã‚’ãã®ã¾ã¾ä½¿ç”¨ã™ã‚‹ã€‚
                if (coords) {
                    textElement.style.left = `${coords.x}px`;
                    textElement.style.top = `${coords.y}px`;
                    textElement.style.backgroundColor = color;
                    textElement.style.display = 'block';
                    textElement.querySelector('.remote-cursor-label').style.backgroundColor = color;
                    textElement.querySelector('.remote-cursor-label').style.top = '1.5em'; 
                } else {
                    textElement.style.display = 'none';
                }
            } 
            
            // B. ãƒ•ãƒªãƒ¼ãƒ«ãƒ¼ãƒ  ã¾ãŸã¯ ãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ¼ã‚½ãƒ«æƒ…å ±ãŒãªã„å ´åˆ (ãƒã‚¦ã‚¹è¿½å¾“)
            else if (room === 'free' || !isText) { 
                if (textElement) textElement.style.display = 'none'; // ãƒã‚¦ã‚¹ãŒæœ‰åŠ¹ãªå ´åˆã¯ç¸¦ç·šã‚’éè¡¨ç¤ºã«ã™ã‚‹
                
                if (position && position.x !== undefined && position.y !== undefined && position.x >= 0) {
                    mouseElement.style.left = `${position.x}px`;
                    mouseElement.style.top = `${position.y}px`;
                    mouseElement.style.display = 'block';

                    if (room === 'free') {
                        // æç”»ãƒ«ãƒ¼ãƒ : ãƒ–ãƒ©ã‚·ã‚µã‚¤ã‚ºè¡¨ç¤º
                        const size = tool === 'pen' || tool === 'eraser' ? penWidth : 10;
                        mouseElement.style.width = `${size}px`;
                        mouseElement.style.height = `${size}px`;
                        mouseElement.style.margin = `-${size / 2}px 0 0 -${size / 2}px`;
                        mouseElement.style.backgroundColor = tool === 'pen' ? color : 'transparent';
                        mouseElement.style.border = `2px solid ${tool === 'pen' ? color : 'red'}`;
                    } else {
                        // ãƒ†ã‚­ã‚¹ãƒˆãƒ«ãƒ¼ãƒ  (ãƒã‚¦ã‚¹ãƒ¢ãƒ¼ãƒ‰): æ¨™æº–ãƒã‚¤ãƒ³ã‚¿ãƒ¼
                        mouseElement.style.backgroundColor = color;
                        mouseElement.style.border = '2px solid white';
                        mouseElement.style.width = '10px';
                        mouseElement.style.height = '10px';
                        mouseElement.style.margin = '-5px 0 0 -5px';
                    }
                    mouseElement.querySelector('.remote-cursor-label').style.backgroundColor = color;
                    mouseElement.querySelector('.remote-cursor-label').style.top = `-1.5em`;
                } else {
                    // åº§æ¨™ãŒãªã„ã€ã¾ãŸã¯-1,-1ã®å ´åˆã¯éè¡¨ç¤º
                    mouseElement.style.display = 'none';
                }
            }
        }
        
        function createCursorElement(id, container, nickname, color, cursorType) {
            const element = document.createElement('span');
            element.id = id;
            element.className = `remote-cursor ${cursorType}`;
            
            const label = document.createElement('span');
            label.className = 'remote-cursor-label';
            label.textContent = nickname;
            label.style.backgroundColor = color;
            
            element.appendChild(label);
            container.appendChild(element);
            return element;
        }

        // [æ³¨æ„] getTextCaretRects é–¢æ•°ã¯å‰Šé™¤ã•ã‚Œã€getTextareaCaretPosition ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

        function sendCursorUpdate(room, data = {}) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'cursor_update',
                    room: room,
                    nickname: nickname,
                    tool: currentTool,
                    penColor: currentPenColor,
                    penWidth: currentPenWidth,
                    ...data 
                }));
            }
        }

        function sendTextUpdate(room, textarea) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'content_update',
                    room: room,
                    nickname: nickname,
                    content: textarea.value, 
                    lyrics: textarea.value, 
                    urls: musicUrls 
                }));
            }
        }


        // =========================================================
        // â˜…â˜…â˜… 3. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (è¿½å¾“ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åˆ¶å¾¡) â˜…â˜…â˜…
        // =========================================================

        function setupGlobalMouseTracking() {
            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢å¤–ã®ã‚¨ãƒªã‚¢ã§ã®ãƒã‚¦ã‚¹ãƒ ãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆã®ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚° (isText: false)
            const trackMouse = (room, element) => {
                element.addEventListener('mousemove', (e) => {
                    if (currentRoom === room) {
                        const rect = element.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        sendCursorUpdate(room, { isText: false, position: { x: x, y: y } });
                    }
                });
                // ãƒã‚¦ã‚¹ã‚¢ã‚¦ãƒˆã§åº§æ¨™ã‚’ã‚¯ãƒªã‚¢
                element.addEventListener('mouseout', () => {
                     if (currentRoom === room) {
                         sendCursorUpdate(room, { isText: false, position: { x: -1, y: -1 } });
                     }
                });
            };

            // ãƒ•ãƒªãƒ¼ãƒ«ãƒ¼ãƒ å…¨ä½“ã€å°èª¬/éŸ³æ¥½ãƒ«ãƒ¼ãƒ ã®è¦ªè¦ç´  (ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢å¤–)
            trackMouse('free', drawingRoomContent);
            trackMouse('novel', novelRoomContent);
            trackMouse('music', musicRoomContent); 
        }

        function setupTextareaTracking(textarea, room) {
            
            // ã€ä¿®æ­£ç‚¹ã€‘ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢å†…ã§ã®ãƒã‚¦ã‚¹ãƒ ãƒ¼ãƒ–ï¼šãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ã‚’è¿½å¾“ã•ã›ã‚‹ (isText: false)
            textarea.addEventListener('mousemove', (e) => {
                 if (currentRoom === room) {
                    const rect = textarea.getBoundingClientRect();
                    // ã‚«ãƒ¼ã‚½ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã¯ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°(15px)ã®å ´æ‰€ã‹ã‚‰å§‹ã¾ã‚‹ãŸã‚ã€ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°åˆ†ã‚’åŠ ç®—
                    const x = e.clientX - rect.left + 15; 
                    const y = e.clientY - rect.top + 15;
                    sendCursorUpdate(room, { isText: false, position: { x: x, y: y } });
                 }
            });

            // æ–‡å­—å…¥åŠ›æ™‚ï¼šã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ›´æ–°ã‚’**å³æ™‚**é€ä¿¡ã—ã€ç¸¦ç·šã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚‚é€ä¿¡ (isText: true)
            textarea.addEventListener('input', () => {
                sendTextUpdate(room, textarea); // â˜…ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜ ã®ãŸã‚ã®å³æ™‚é€ä¿¡â˜…
                sendCursorUpdate(room, { isText: true, position: textarea.selectionStart }); 
            });
            
            // ã‚¯ãƒªãƒƒã‚¯ã€ã‚­ãƒ¼ã‚¢ãƒƒãƒ—ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ï¼šç¸¦ç·šã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã®ã¿é€ä¿¡ (isText: true)
            textarea.addEventListener('click', () => sendCursorUpdate(room, { isText: true, position: textarea.selectionStart }));
            textarea.addEventListener('keyup', (e) => {
                sendCursorUpdate(room, { isText: true, position: textarea.selectionStart });
            });
            textarea.addEventListener('scroll', () => sendCursorUpdate(room, { isText: true, position: textarea.selectionStart })); 
            
            // ãƒã‚¦ã‚¹ã‚¢ã‚¦ãƒˆæ™‚ã€ã‚«ãƒ¼ã‚½ãƒ«è¡¨ç¤ºã‚’è§£é™¤
            textarea.addEventListener('mouseout', () => {
                // 1. ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹ (x:-1, y:-1)
                sendCursorUpdate(room, { isText: false, position: { x: -1, y: -1 } }); 
                // 2. ãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ¼ã‚½ãƒ«ã‚‚éè¡¨ç¤ºã«ã™ã‚‹ (position: -1)
                sendCursorUpdate(room, { isText: true, position: -1 });
            });
        }

        setupTextareaTracking(novelTextarea, 'novel');
        setupTextareaTracking(lyricsTextarea, 'music');


        // =========================================================
        // â˜…â˜…â˜… 4. å„ãƒ«ãƒ¼ãƒ ã®å€‹åˆ¥ãƒ­ã‚¸ãƒƒã‚¯ (æç”»/éŸ³æ¥½URL) â˜…â˜…â˜…
        // =========================================================
        
        // --- æç”»ãƒ­ã‚¸ãƒƒã‚¯ ---
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        ctx.lineCap = 'round';
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, canvas.width, canvas.height); 
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        function setTool(tool) {
            currentTool = tool;
            penToolButton.classList.remove('active');
            eraserToolButton.classList.remove('active');
            if (tool === 'pen') {
                penToolButton.classList.add('active');
                ctx.globalCompositeOperation = 'source-over'; 
            } else if (tool === 'eraser') {
                eraserToolButton.classList.add('active');
                ctx.globalCompositeOperation = 'destination-out'; 
            }
            sendCursorUpdate('free', { isText: false, position: { x: lastX, y: lastY } });
        }

        penToolButton.addEventListener('click', () => setTool('pen'));
        eraserToolButton.addEventListener('click', () => setTool('eraser'));
        clearCanvasButton.addEventListener('click', () => {
             ctx.fillStyle = '#fff';
             ctx.fillRect(0, 0, canvas.width, canvas.height);
             if (ws && ws.readyState === WebSocket.OPEN) {
                 ws.send(JSON.stringify({ type: 'content_update', room: 'free', action: 'clear_canvas' }));
             }
             saveDrawing(true); 
        });
        setTool('pen'); 

        function draw(e) {
            if (currentRoom !== 'free') return;
            const [currentX, currentY] = [e.offsetX, e.offsetY];

            if (!isDrawing) {
                 [lastX, lastY] = [currentX, currentY];
                 return;
            }
            
            const strokeColor = currentTool === 'eraser' ? 'rgba(0,0,0,1)' : currentPenColor; 
            
            ctx.beginPath();
            ctx.strokeStyle = strokeColor;
            ctx.lineWidth = currentPenWidth;
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(currentX, currentY);
            ctx.stroke();

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'content_update',
                    room: 'free',
                    nickname: nickname,
                    line: { x0: lastX, y0: lastY, x1: currentX, y1: currentY, color: strokeColor, width: currentPenWidth, tool: currentTool },
                    penColor: currentPenColor, 
                    penWidth: currentPenWidth
                }));
            }
            
            [lastX, lastY] = [currentX, currentY];
        }

        canvas.addEventListener('mousedown', (e) => {
            if (currentRoom !== 'free') return;
            isDrawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];
            ctx.globalCompositeOperation = currentTool === 'pen' ? 'source-over' : 'destination-out'; 
        });
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', () => isDrawing = false);
        canvas.addEventListener('mouseout', () => isDrawing = false);
        
        penColorInput.addEventListener('change', (e) => { 
            currentPenColor = e.target.value; 
            ctx.strokeStyle = currentPenColor;
        });
        penWidthInput.addEventListener('input', (e) => {
            currentPenWidth = parseInt(e.target.value);
            widthValueSpan.textContent = currentPenWidth;
        });

        function handleReceivedDrawing(data) {
             if (data.action === 'clear_canvas') {
                ctx.fillStyle = '#fff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                return;
            }
            if (data.line) {
                const line = data.line;
                const originalCompositeOperation = ctx.globalCompositeOperation;
                const originalStrokeStyle = ctx.strokeStyle;
                const originalLineWidth = ctx.lineWidth;
                
                ctx.globalCompositeOperation = line.tool === 'eraser' ? 'destination-out' : 'source-over';
                
                ctx.beginPath();
                ctx.strokeStyle = line.color;
                ctx.lineWidth = line.width;
                ctx.moveTo(line.x0, line.y0);
                ctx.lineTo(line.x1, line.y1);
                ctx.stroke();
                
                ctx.strokeStyle = originalStrokeStyle;
                ctx.lineWidth = originalLineWidth;
                ctx.globalCompositeOperation = originalCompositeOperation;
            }
        }
        
        // --- éŸ³æ¥½ãƒ«ãƒ¼ãƒ  (URLä¸¦ã¹æ›¿ãˆ) ãƒ­ã‚¸ãƒƒã‚¯ ---
        
        function renderMusicUrls() {
            musicUrlsList.innerHTML = '';
            musicUrls.forEach((url, index) => {
                const li = document.createElement('li');
                li.draggable = true;
                li.dataset.index = index;
                li.textContent = url.length > 50 ? url.substring(0, 50) + '...' : url;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-url';
                removeBtn.textContent = 'å‰Šé™¤';
                removeBtn.addEventListener('click', () => removeMusicUrl(index));
                
                li.appendChild(removeBtn);
                musicUrlsList.appendChild(li);
            });
            setupDragAndDrop();
        }

        addMusicUrlButton.addEventListener('click', () => {
            const url = newMusicUrlInput.value.trim();
            if (url) {
                musicUrls.push(url);
                newMusicUrlInput.value = '';
                sendTextUpdate('music', lyricsTextarea); 
            }
        });
        
        function removeMusicUrl(index) {
            musicUrls.splice(index, 1);
            sendTextUpdate('music', lyricsTextarea); 
        }
        
        function setupDragAndDrop() {
            let dragStartIndex;

            musicUrlsList.querySelectorAll('li').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    dragStartIndex = parseInt(item.dataset.index);
                    e.dataTransfer.setData('text/plain', dragStartIndex);
                    setTimeout(() => item.classList.add('dragging'), 0);
                });

                item.addEventListener('dragend', () => item.classList.remove('dragging'));

                item.addEventListener('dragover', (e) => {
                    e.preventDefault(); 
                    const draggingItem = document.querySelector('.dragging');
                    if (draggingItem && draggingItem !== item) {
                        const boundingBox = item.getBoundingClientRect();
                        const offset = boundingBox.y + boundingBox.height / 2;
                        
                        if (e.clientY > offset) {
                            musicUrlsList.insertBefore(draggingItem, item.nextSibling);
                        } else {
                            musicUrlsList.insertBefore(draggingItem, item);
                        }
                    }
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    
                    const newUrls = Array.from(musicUrlsList.children).map(li => 
                        li.textContent.replace(/å‰Šé™¤$/, '').trim() 
                    );
                    
                    musicUrls = newUrls;
                    sendTextUpdate('music', lyricsTextarea); 
                });
            });
        }
        
        // =========================================================
        // â˜…â˜…â˜… 5. å…±é€šæ©Ÿèƒ½ï¼šãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã¨èª­ã¿è¾¼ã¿ (ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡) â˜…â˜…â˜…
        // =========================================================
        
        function getCurrentRoom() { return currentRoom; }
        
        // ã€æ³¨æ„ã€‘ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã® '/api/save' ã¨ '/api/publish' ãŒå¿…è¦ã§ã™ã€‚

        async function loadDrawing() {
            try {
                // ä»®ã®ã‚µãƒ¼ãƒãƒ¼ãƒ‘ã‚¹
                const res = await fetch('/data/free_data.txt');
                if (!res.ok) { ctx.fillRect(0, 0, canvas.width, canvas.height); return; }
                const dataURL = await res.text();
                if (dataURL) {
                    const img = new Image();
                    img.onload = () => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = dataURL;
                } else {
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
            } catch (error) { console.error('æç”»ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error); }
        }
        async function loadTextData(room) {
            try {
                // ä»®ã®ã‚µãƒ¼ãƒãƒ¼ãƒ‘ã‚¹
                const res = await fetch(`/data/${room}_data.txt`);
                if (!res.ok) { return ''; }
                return res.text();
            } catch (error) { console.error(`${room}ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:`, error); return ''; }
        }
        async function saveDrawing(clear = false) {
            const dataURL = clear ? '' : canvas.toDataURL('image/png');
            // ä»®ã®ã‚µãƒ¼ãƒãƒ¼ãƒ‘ã‚¹
            const res = await fetch('/api/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room: 'free', content: dataURL })
            });
            if (res.ok) { console.log('æç”»ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚'); } else { console.error('æç”»ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); }
        }
        async function saveTextData(room, content) {
            // ä»®ã®ã‚µãƒ¼ãƒãƒ¼ãƒ‘ã‚¹
            const res = await fetch('/api/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room: room, content: content })
            });
            if (res.ok) { console.log(`${room}ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`); } else { console.error(`${room}ã®ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`); }
        }


        // ----------------------------------------------------
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (ä¿å­˜ãƒ»å…¬é–‹)
        // ----------------------------------------------------

        saveButton.addEventListener('click', async () => {
            const room = getCurrentRoom();
            if (room === 'free') {
                await saveDrawing();
            } else if (room === 'novel') {
                await saveTextData('novel', novelTextarea.value);
            } else if (room === 'music') {
                // URLã¨æ­Œè©ã‚’çµåˆã—ã¦ä¿å­˜
                const urlContent = musicUrls.map(url => `[URL: ${url}]`).join('\n') + '\n\n';
                const combinedContent = urlContent + `[æ­Œè©/ã‚¢ã‚¤ãƒ‡ã‚¢]:\n` + lyricsTextarea.value;
                await saveTextData('music', combinedContent);
            }
            publishStatus.textContent = 'ä¸€æ™‚ä¿å­˜ã—ã¾ã—ãŸã€‚';
            publishStatus.style.color = '#2196F3';
            setTimeout(() => { publishStatus.textContent = ''; }, 3000);
        });

        publishButton.addEventListener('click', async () => {
            const room = getCurrentRoom();
            const title = workTitleInput.value.trim();
            
            let content = '';
            let contentType = '';
            
            if (!title) {
                publishStatus.textContent = 'ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                publishStatus.style.color = 'red';
                return;
            }

            if (room === 'free') {
                content = canvas.toDataURL('image/png');
                contentType = 'image';
            } else if (room === 'novel') {
                content = `ä½œè€…: ${nickname}\n\n${novelTextarea.value}`;
                contentType = 'text';
            } else if (room === 'music') {
                const urlLines = musicUrls.map(url => `[æ¥½è­œ/URL]: ${url}`).join('\n');
                const lyrics = lyricsTextarea.value;
                content = `ä½œè€…: ${nickname}\n${urlLines}\n\n[æ­Œè©/ã‚¢ã‚¤ãƒ‡ã‚¢]:\n${lyrics}`;
                contentType = 'text'; 
            }

            // ä»®ã®ã‚µãƒ¼ãƒãƒ¼ãƒ‘ã‚¹
            const res = await fetch('/api/publish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, room, content, content_type: contentType }) 
            });

            if (res.ok) {
                publishStatus.textContent = `ä½œå“ã€Œ${title}ã€ã‚’å…¬é–‹ã—ã¾ã—ãŸï¼`;
                publishStatus.style.color = 'green';
                workTitleInput.value = '';
            } else {
                publishStatus.textContent = 'ä½œå“ã®å…¬é–‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                publishStatus.style.color = 'red';
            }
        });

    </script>
</body>
</html>